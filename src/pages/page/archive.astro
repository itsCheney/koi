---
import Layout from "../../layouts/BlogPage.astro";
import { filterPosts, type Post } from "../../utils/misc";
import { getCollection } from "astro:content";

const posts = filterPosts(await getCollection("blog"), {
  filterDraft: true,
  filterUnlisted: true,
}).sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// 按年份分组
const grouped = new Map<number, Post[]>();
posts.forEach(p => {
  const y = p.data.pubDate.getFullYear();
  if (!grouped.has(y)) grouped.set(y, []);
  grouped.get(y)?.push(p);
});

const years = [...grouped.keys()].sort((a, b) => b - a);
const total = posts.length;
---

<Layout title="归档" description="按年份筛选文章">
  <div class="mt-3 text-lg text-zinc-600 dark:text-zinc-300">
  如今，本博客已经有 <span class="font-semibold text-zinc-800 dark:text-zinc-100">{total}</span> 篇文章了呢。
  </div>

  <div class="grid md:grid-cols-4 gap-6 mt-6">
    <!-- 左侧年份筛选 -->
    <aside class="md:col-span-1 p-4 rounded-lg">
      <h3 class="font-semibold text-lg">年份</h3>
      <div class="mt-3 flex flex-wrap gap-2" id="year-list">
        <button class="year-btn active px-3 py-1 rounded-full text-sm !bg-black/10 dark:!bg-white/10 text-zinc-900 dark:text-zinc-100 border border-transparent" data-year="all">
          全部
        </button>
        {years.map(y => (
          <button class="year-btn px-3 py-1 rounded-full text-sm border border-black/10 dark:border-white/10 text-zinc-500 dark:text-zinc-400 hover:bg-black/5 dark:hover:bg-white/5" data-year={String(y)}>
            {y} <span class="opacity-60">({grouped.get(y)?.length})</span>
          </button>
        ))}
      </div>
    </aside>

    <!-- 右侧文章列表 -->
    <section class="md:col-span-3" id="post-list">
      {years.map(year => (
        <div class="year-group" data-year={String(year)}>
          <h2 class="text-xl font-semibold mb-3 mt-4 text-zinc-700 dark:text-zinc-300">{year}</h2>
          <div class="flex flex-col gap-4">
            {grouped.get(year)?.map(post => (
              <a href={`/post/${post.slug}/`} class="post-item block p-4 rounded-lg bg-black/5 dark:bg-black/10 border border-black/10 dark:border-white/10 transition-colors hover:bg-black/10 dark:hover:bg-white/5" data-year={String(year)}>
                <h3 class="text-lg font-medium">{post.data.title}</h3>
                <p class="text-sm text-zinc-500 dark:text-zinc-400 mt-1 line-clamp-2">{post.data.description}</p>
                <div class="mt-2 text-xs text-zinc-400 dark:text-zinc-500 flex items-center gap-2">
                  <span>{post.data.pubDate.toLocaleDateString()}</span>
                  {post.data.tags && post.data.tags.length > 0 && (
                    <span class="flex flex-wrap gap-2">
                      {post.data.tags.map(tag => (
                        <span class="inline-block">#{tag}</span>
                      ))}
                    </span>
                  )}
                </div>
              </a>
            ))}
          </div>
        </div>
      ))}
    </section>
  </div>

  <script>
    const yearList = document.getElementById('year-list');
    const yearButtons = Array.from(yearList.querySelectorAll('.year-btn'));
    const yearGroups = Array.from(document.querySelectorAll('.year-group'));

    let activeYear = 'all';

    yearList.addEventListener('click', (e) => {
      const target = (e.target as HTMLElement).closest('.year-btn') as HTMLElement;
      if (target && target.classList.contains('year-btn')) {
        activeYear = target.dataset.year || 'all';
        updateActiveYearButton();
        filterPosts();
      }
    });

    function updateActiveYearButton() {
      yearButtons.forEach(button => {
        const isActive = button.dataset.year === activeYear;
        button.classList.toggle('!bg-black/10', isActive);
        button.classList.toggle('dark:!bg-white/10', isActive);
        button.classList.toggle('text-zinc-900', isActive);
        button.classList.toggle('dark:text-zinc-100', isActive);
        button.classList.toggle('border-transparent', isActive);
        button.classList.toggle('border-black/10', !isActive);
        button.classList.toggle('dark:border-white/10', !isActive);
        button.classList.toggle('text-zinc-500', !isActive);
        button.classList.toggle('dark:text-zinc-400', !isActive);
      });
    }

    function filterPosts() {
      yearGroups.forEach(group => {
        const year = group.dataset.year;
        if (activeYear === 'all' || year === activeYear) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    }
  </script>
</Layout>
